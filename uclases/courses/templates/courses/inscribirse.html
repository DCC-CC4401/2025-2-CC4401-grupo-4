{% extends 'base.html' %}

{% block title %}Inscribirse en {{ oferta.titulo }}{% endblock %}

{% block content %}
<section class="min-h-screen flex items-center justify-center bg-background py-12">
  <div class="container max-w-2xl mx-auto bg-card border border-border rounded-2xl p-8 shadow-xl">
    <h1 class="text-2xl font-bold mb-6 text-center">Selecciona un horario</h1>

    <form method="POST">
      {% csrf_token %}
      <div class="space-y-4">
        {% for horario in horarios_ordenados %}
          <div class="relative border border-border rounded-xl p-4 {% if horario.usuario_inscrito %}bg-muted/20 opacity-75{% elif horario.cupos_totales > 0 %}hover:bg-muted/40{% else %}opacity-60 bg-muted/20{% endif %}">
            <!-- Tag de estado -->
            {% if horario.usuario_inscrito %}
              <div class="absolute top-2 right-2">
                {% if horario.inscripcion_estado == 0 %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500/20 text-yellow-600 border border-yellow-500/30">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                    Pendiente
                  </span>
                {% elif horario.inscripcion_estado == 1 %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-600 border border-green-500/30">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Aceptado
                  </span>
                {% elif horario.inscripcion_estado == 3 %}
                  <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-600 border border-blue-500/30">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Completado
                  </span>
                {% endif %}
              </div>
            {% endif %}
            
            <label class="flex items-center justify-between {% if not horario.usuario_inscrito and horario.cupos_totales > 0 %}cursor-pointer{% else %}cursor-not-allowed{% endif %}">
              <div class="{% if horario.usuario_inscrito %}pr-24{% endif %}">
                <p class="font-semibold {% if horario.cupos_totales == 0 or horario.usuario_inscrito %}text-foreground/50{% endif %}">{{ horario.get_dia_display }}</p>
                <p class="text-sm {% if horario.cupos_totales == 0 or horario.usuario_inscrito %}text-foreground/40{% else %}text-foreground/70{% endif %}">
                  {{ horario.hora_inicio|time:"H:i" }} - {{ horario.hora_fin|time:"H:i" }}
                </p>
              </div>
              <div class="text-right">
                {% if horario.usuario_inscrito %}
                  <input type="radio" name="horario" value="{{ horario.id }}" disabled class="accent-primary opacity-50">
                  <p class="text-xs text-foreground/50 italic mt-1">Ya inscrito</p>
                {% elif horario.cupos_totales > 0 %}
                  <input type="radio" name="horario" value="{{ horario.id }}" required class="accent-primary">
                  <p class="text-sm text-foreground/80">Cupos: {{ horario.cupos_totales }}</p>
                {% else %}
                  <input type="radio" name="horario" value="{{ horario.id }}" disabled class="accent-primary opacity-50">
                  <p class="text-sm text-red-500 font-semibold">Sin cupos</p>
                {% endif %}
              </div>
            </label>
          </div>
        {% empty %}
          <p class="text-center text-foreground/60">No hay horarios disponibles para esta oferta.</p>
        {% endfor %}
      </div>
      
      <!-- Mensaje cuando todos están inscritos -->
      {% if horarios_ordenados %}
        {% with tiene_disponibles=False %}
          {% for h in horarios_ordenados %}
            {% if not h.usuario_inscrito and h.cupos_totales > 0 %}
              {% with tiene_disponibles=True %}{% endwith %}
            {% endif %}
          {% endfor %}
          {% if not tiene_disponibles %}
            <div class="text-center py-8 mt-4 border border-border rounded-xl bg-muted/10">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="text-foreground/80 font-semibold">Ya estás inscrito en todos los horarios disponibles</p>
              <p class="text-sm text-foreground/60 mt-2">No hay más horarios en los que puedas inscribirte</p>
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}

      <div class="mt-8 flex gap-3">
        <button type="submit" 
                class="cosmic-button flex-1 bg-blue-500/60 hover:bg-blue-500 text-foreground disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-blue-500/60"
                id="submit-btn">
          Confirmar inscripción
        </button>
        <a href="{% url 'courses:oferta_detail' oferta.pk %}"
           class="cosmic-button flex-1 bg-foreground/10 text-foreground text-center hover:bg-foreground/20">
          Cancelar
        </a>
      </div>
      
      <script>
      // Deshabilitar botón si no hay horarios con cupos disponibles
      document.addEventListener('DOMContentLoaded', function() {
        const submitBtn = document.getElementById('submit-btn');
        const horariosDisponibles = document.querySelectorAll('input[name="horario"]:not([disabled])');
        
        if (horariosDisponibles.length === 0) {
          submitBtn.disabled = true;
          submitBtn.title = "No hay horarios disponibles";
        }
      });
      </script>
    </form>
  </div>
</section>
{% endblock %}
