{% extends "base.html" %}  {% load static %}

{% block content %}
<section class="min-h-screen items-center justify-center bg-background pt-20 pb-16">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6">Proponer Clase</h1>
        <p class="mb-4 text-secondary-foreground">Estás proponiendo una clase al solicitante: <strong>{{ solicitante.user.username }}</strong>.</p>
        
        <form method="post">
            {% csrf_token %}

            <section class="mb-6 p-6 border rounded-lg bg-indigo-100/50 border-indigo-300">
                <h2 class="text-xl font-semibold mb-2 text-indigo-800">Curso</h2>
                <p class="text-lg font-bold text-indigo-900">{{ ramo.name }}</p>
                <p class="text-sm text-indigo-700 mt-1">Este es el curso de la solicitud original. No puede ser modificado.</p>
            </section>
            <section class="mb-6 p-6 border rounded-lg bg-card shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Información de la Oferta</h2>
                
                {% for field in form %}
                    {% if field.name != 'ramo' %}
                        <div class="mb-4">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-xs italic mt-1">{{ field.errors }}</p>
                            {% endif %}
                            {% if field.help_text %}
                                <p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
                
                <input type="hidden" name="ramo" value="{{ ramo.id }}"> 
            </section>

            <section class="rounded-xl border border-border bg-background/60 p-6 space-y-5">
                        <div class="flex items-start justify-between gap-4 flex-wrap">
                            <div>
                                <h2 class="text-lg font-semibold text-foreground">
                                    Horarios ofertados
                                </h2>
                                <p class="text-sm text-foreground/60 mt-1">
                                    Agrega tanta disponibilidad como necesites. Cada
                                    bloque incluye día, horario y cupos.
                                </p>
                            </div>
                            <button
                                type="button"
                                id="addHorario"
                                class="cosmic-button inline-flex items-center gap-2"
                            >
                                <span class="text-lg">+</span>
                                Agregar horario
                            </button>
                        </div>

                        {{ formset.management_form }}
                        {% if formset.non_form_errors %}
                        <div class="rounded-lg border border-red-500/40 bg-red-500/10 text-red-500 px-4 py-3 text-sm">
                            {% for error in formset.non_form_errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Existing schedule rows -->
                        <div id="horarios-container" class="space-y-4">
                            {% for horario_form in formset %}
                            <div class="horario-form rounded-xl border border-border bg-card/80 p-5 shadow-sm" data-horario-form>
                                {% if horario_form.can_delete %}
                                <div class="flex justify-end mb-3">
                                    <button
                                        type="button"
                                        class="px-3 py-1 text-sm font-semibold text-foreground/70 hover:text-red-500 hover:bg-red-500/10 rounded-md"
                                        data-delete-toggle
                                        aria-label="Eliminar horario"
                                    >
                                        x
                                    </button>
                                </div>
                                <span class="hidden">{{ horario_form.DELETE }}</span>
                                {% endif %}
                                {% for hidden in horario_form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                                {% if horario_form.non_field_errors %}
                                <div class="mb-3 text-sm text-red-500">
                                    {% for error in horario_form.non_field_errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Schedule fields -->
                                <div class="flex flex-wrap items-justify justify-between gap-4">
                                {% for field in horario_form.visible_fields %}
                                    {% if field.name != 'DELETE' %}
                                        <div class="flex flex-col gap-1 w-28">
                                            <label
                                                class="text-sm font-medium text-foreground/80"
                                                for="{{ field.id_for_label }}"
                                            >
                                                {{ field.label }}
                                            </label>
                                            {{ field }}
                                            {% if field.help_text %}
                                                <span class="text-xs text-foreground/60">
                                                    {{ field.help_text }}
                                                </span>
                                            {% endif %}
                                            {% for error in field.errors %}
                                                <span class="text-xs text-red-500">
                                                    {{ error }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                </div>

                            </div>
                            {% endfor %}
                        </div>

                        <!-- Prototype for JS-added schedules -->
                        <template id="empty-form-template">
                            <div class="horario-form rounded-xl border border-border bg-card/80 p-5 pt-2 shadow-sm" data-horario-form>
                                {% if formset.can_delete %}
                                <div class="flex justify-end mb-3">
                                    <button
                                        type="button"
                                        class="px-3 py-1 font-bold text-primary hover:text-red-500 hover:bg-red-500/10 rounded-md"
                                        data-delete-toggle
                                        aria-label="Eliminar horario"
                                    >
                                        x
                                    </button>
                                </div>
                                <span class="hidden">{{ formset.empty_form.DELETE }}</span>
                                {% endif %}
                                {% for hidden in formset.empty_form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}

                                <div class="flex flex-wrap items-justify justify-between gap-4">
                                {% for field in formset.empty_form.visible_fields %}
                                    {% if field.name != 'DELETE' %}
                                        <div class="flex flex-col gap-1 w-28">
                                            <label
                                                class="text-sm font-medium text-foreground/80"
                                                for="{{ field.id_for_label }}"
                                            >
                                                {{ field.label }}
                                            </label>
                                            {{ field.as_widget }}
                                            {% if field.help_text %}
                                                <span class="text-xs text-foreground/60">
                                                    {{ field.help_text }}
                                                </span>
                                            {% endif %}
                                            {% for error in field.errors %}
                                                <span class="text-xs text-red-500">
                                                    {{ error }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                </div>
                            </div>
                        </template>
                    </section>

            <button type="submit" 
                    class="cosmic-button bg-green-600/50 hover:bg-green-600/90 text-foreground mt-6 w-full">
                Publicar Oferta y Proponer
            </button>
        </form>
    </div>
</section>
{% endblock content %}

{% block scripts %}
<script>
    (function () {
        const prefix = "horarios";
        const totalInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
        const container = document.getElementById("horarios-container");
        const template = document.getElementById("empty-form-template");
        const addButton = document.getElementById("addHorario");

        if (!totalInput || !container || !template || !addButton) {
            return;
        }

        const wireDeleteButtons = () => {
            container.querySelectorAll('[data-delete-toggle]').forEach((button) => {
                if (button.dataset.deleteBound === 'true') {
                    return;
                }
                button.dataset.deleteBound = 'true';
                button.addEventListener('click', () => {
                    const formCard = button.closest('[data-horario-form]');
                    if (!formCard) {
                        return;
                    }
                    const deleteCheckbox = formCard.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                    }
                    formCard.classList.add('hidden');
                });
            });
        };

        wireDeleteButtons();

        addButton.addEventListener("click", () => {
            const index = parseInt(totalInput.value, 10);
            const html = template.innerHTML.replace(/__prefix__/g, index);
            container.insertAdjacentHTML("beforeend", html);
            totalInput.value = index + 1;
            wireDeleteButtons();
        });
    })();
</script>
{% endblock %}