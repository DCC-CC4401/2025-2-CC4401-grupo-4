{% comment %} 
Componente reutilizable para abrir un modal de edición. Requiere
variables: - form: instancia del formulario Django - title: título del modal -
action_url: (opcional) endpoint donde se enviará el form (default: página actual) - 
button_label: (opcional) texto del botón
{% endcomment %}

<div class="inline-block">
    <!-- Botón -->
    <button
        type="button"
        onclick="toggleModal('{{ form.prefix }}', true)"
        class="inline-flex items-center justify-center rounded-full text-foreground/60 transition hover:text-primary hover:scale-110"
        aria-label="Editar {{ title|default:'sección' }}"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-pencil"
        >
            <path d="m18 2 4 4-14 14H4v-4Z"></path>
            <path d="m16 4 4 4"></path>
        </svg>
    </button>

    <!-- Modal -->
    <div
        id="modal-{{ form.prefix }}"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-100"
        data-modal-root="inline"
    >
        <div
            class="bg-card text-foreground rounded-2xl border border-border shadow-xl card-hover max-w-lg w-full p-6 relative"
        >
            <!-- Cerrar -->
            <button
                type="button"
                onclick="toggleModal('{{ form.prefix }}', false)"
                class="absolute top-3 right-3 inline-flex w-8 h-8 items-center justify-center rounded-full text-foreground/60 hover:text-primary hover:bg-primary/10 transition"
            >
                ✕
            </button>

            <h3 class="text-xl font-semibold mb-4">{{ title }}</h3>

            <form
                method="post"
                action="{{ action_url|default:request.path }}"
                class="space-y-4"
            >
                {% csrf_token %}
                <input type="hidden" name="form_prefix" value="{{ form.prefix }}" />
                {{ form.as_p }}

                <div class="flex justify-end gap-2 mt-4">
                    <button
                        type="button"
                        onclick="toggleModal('{{ form.prefix }}', false)"
                        class="px-4 py-2 border border-border rounded-lg text-foreground/70 hover:bg-background/80 transition"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="cosmic-button rounded-lg">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleModal(prefix, show) {
        let modal = document.getElementById(`modal-${prefix}`);
        if (!modal) {
            return;
        }

        if (!modal.dataset.portalized) {
            document.body.appendChild(modal);
            modal.dataset.portalized = "true";
            
            // Agregar event listener para cerrar al hacer click fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    toggleModal(prefix, false);
                }
            });
        }

        modal.classList.toggle("hidden", !show);
        modal.classList.toggle("flex", show);

        if (show) {
            document.body.classList.add("overflow-hidden");
        } else if (!document.querySelector('[data-modal-root]:not(.hidden)')) {
            document.body.classList.remove("overflow-hidden");
        }
    }
</script>
